# AI Development Instructions - YouTube Media Player

**Project:** Offline-first media player with YouTube download capability  
**Tech Stack:** React 19 + Express + PostgreSQL + Docker  
**Purpose:** Universal instructions for GitHub Copilot CLI, Claude Code CLI, and other AI assistants

> ğŸ“š **Detailed instructions:** `.github/instructions/` directory (16 files, 257KB)  
> ğŸ¤– **Specialized agents:** `.github/copilot/agents/` directory (10 agents, 66KB)

---

## ğŸ¯ Project Overview

**Goal:** Build a local media player that downloads music/videos from YouTube and plays them offline with full player features (playlists, queue, liked songs, play history).

**Offline-First Philosophy:**
- ALL player features work without internet
- Downloads only require internet during download phase
- Priority: Player > Library Management > Download

**Tech Stack:**
- **Frontend:** React 19 + TypeScript + Vite + Zustand
- **Backend:** Node.js 18+ + Express + TypeScript + Prisma ORM
- **Database:** PostgreSQL 15
- **Infrastructure:** Docker (3 containers: frontend, backend, postgres)
- **Download:** ytdl-core or yt-dlp + FFmpeg
- **Testing:** Jest (backend) + Vitest (frontend) + Playwright (E2E)

---

## ğŸ—ï¸ Architecture Principles

### 7-Layer Architecture
1. **Presentation Layer:** React components, UI/UX
2. **State Management:** Zustand stores (player, library, download)
3. **API Client Layer:** Axios with centralized endpoints
4. **API Layer:** Express REST endpoints + Socket.io
5. **Service Layer:** Business logic (media, playlist, download services)
6. **Data Access Layer:** Prisma ORM
7. **Database Layer:** PostgreSQL

### Centralized URL Management
**CRITICAL:** Never hardcode URLs! Use shared constants:
- **Routes:** `shared/constants/routes.ts` - Path definitions
- **Endpoints:** `shared/constants/endpoints.ts` - URL builders
- **Socket Events:** `shared/constants/socket-events.ts` - Event names

Example:
\`\`\`typescript
// Backend
import { API_ROUTES } from '@/shared/constants/routes';
router.get(API_ROUTES.MEDIA.GET_BY_ID, controller);

// Frontend
import { endpoints } from '@/shared/constants/endpoints';
apiClient.get(endpoints.media.getById(id));
\`\`\`

---

## ğŸ“‚ Project Structure

\`\`\`
.
â”œâ”€â”€ frontend/                 # React app (Vite)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/      # React components
â”‚   â”‚   â”œâ”€â”€ pages/           # Route pages
â”‚   â”‚   â”œâ”€â”€ stores/          # Zustand stores
â”‚   â”‚   â”œâ”€â”€ hooks/           # Custom hooks
â”‚   â”‚   â”œâ”€â”€ api/             # API client
â”‚   â”‚   â””â”€â”€ shared/          # Shared constants
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ backend/                  # Express API
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ routes/          # Express routes
â”‚   â”‚   â”œâ”€â”€ controllers/     # Request handlers
â”‚   â”‚   â”œâ”€â”€ services/        # Business logic
â”‚   â”‚   â”œâ”€â”€ middleware/      # Express middleware
â”‚   â”‚   â”œâ”€â”€ errors/          # Custom error classes
â”‚   â”‚   â”œâ”€â”€ utils/           # Utilities
â”‚   â”‚   â””â”€â”€ shared/          # Shared constants
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â””â”€â”€ schema.prisma    # Database schema
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ .github/
â”‚   â”œâ”€â”€ instructions/         # 16 instruction files (auto-loaded by Copilot)
â”‚   â”œâ”€â”€ copilot/agents/      # 10 specialized agents
â”‚   â””â”€â”€ workflows/           # GitHub Actions (CI/CD)
â”‚
â”œâ”€â”€ docker-compose.yml       # Multi-container setup
â”œâ”€â”€ .aiinstructions.md       # This file (universal)
â””â”€â”€ bruno/                   # API testing collection
\`\`\`

---

## ğŸ’» Code Standards

### TypeScript
- **Strict Mode:** All TypeScript strict flags enabled
- **No \`any\`:** Use explicit types or \`unknown\`
- **No floating promises:** Always \`await\` or \`void\`

### ESLint + Prettier
- **Import Order:** builtin â†’ external â†’ internal â†’ parent â†’ sibling
- **Line Length:** 100 characters
- **Semicolons:** Always
- **Quotes:** Single quotes
- **Trailing Commas:** ES5

### Git Commits
- **Format:** Conventional Commits (\`feat:\`, \`fix:\`, \`docs:\`, etc.)
- **Hooks:** Husky runs lint-staged on pre-commit
- **Branches:** \`<type>/<ticket>-<description>\` (e.g., \`feature/123-add-player\`)

---

## ğŸ¨ Frontend Patterns

### Component Structure
\`\`\`typescript
// components/Player/Player.tsx
import { usePlayerStore } from '@/stores/player';
import { endpoints } from '@/shared/constants/endpoints';

export const Player: React.FC = () => {
  const { currentMedia, play, pause } = usePlayerStore();
  
  return (
    <div className="player">
      {/* Component JSX */}
    </div>
  );
};
\`\`\`

### State Management (Zustand)
\`\`\`typescript
// stores/player.ts
import { create } from 'zustand';

interface PlayerState {
  currentMedia: Media | null;
  isPlaying: boolean;
  play: () => void;
  pause: () => void;
}

export const usePlayerStore = create<PlayerState>((set) => ({
  currentMedia: null,
  isPlaying: false,
  play: () => set({ isPlaying: true }),
  pause: () => set({ isPlaying: false }),
}));
\`\`\`

### Custom Hooks
\`\`\`typescript
// hooks/usePlayer.ts
export function usePlayer() {
  const audioRef = useRef<HTMLAudioElement>(null);
  const { currentMedia, play, pause } = usePlayerStore();
  
  // Player logic
  
  return { audioRef, play, pause };
}
\`\`\`

---

## ğŸ”§ Backend Patterns

### Service Layer
\`\`\`typescript
// services/media.service.ts
import { prisma } from '../config/database';
import { NotFoundError } from '../errors';

export class MediaService {
  async getById(id: string) {
    const media = await prisma.media.findUnique({ where: { id } });
    if (!media) throw new NotFoundError('Media', id);
    return media;
  }
}
\`\`\`

### Controller Layer
\`\`\`typescript
// controllers/media.controller.ts
import { MediaService } from '../services/media.service';
import { asyncHandler } from '../middleware/error.middleware';

const mediaService = new MediaService();

export const getById = asyncHandler(async (req, res) => {
  const media = await mediaService.getById(req.params.id);
  res.json({ success: true, data: media });
});
\`\`\`

### Error Handling
\`\`\`typescript
// errors/AppError.ts
export class AppError extends Error {
  constructor(
    public message: string,
    public statusCode: number = 500,
    public code: string = 'INTERNAL_ERROR'
  ) {
    super(message);
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string, id?: string) {
    super(\`\${resource} not found\`, 404, 'NOT_FOUND');
  }
}
\`\`\`

---

## ğŸ—„ï¸ Database Patterns

### Prisma Schema
\`\`\`prisma
model Media {
  id           String    @id @default(uuid())
  title        String
  artist       String
  duration     Int       // seconds
  filePath     String    @unique
  playCount    Int       @default(0)
  liked        Boolean   @default(false)
  lastPlayedAt DateTime?
  createdAt    DateTime  @default(now())
  
  @@index([playCount(sort: Desc)])
  @@index([liked, lastPlayedAt(sort: Desc)])
}
\`\`\`

### Query Optimization
- Use \`select\` to fetch only needed fields
- Use \`include\` for relations (avoid N+1)
- Add indexes for frequently queried fields
- Paginate large datasets

---

## ğŸ§ª Testing Patterns

### Unit Tests (Jest/Vitest)
\`\`\`typescript
describe('MediaService', () => {
  it('should throw when media not found', async () => {
    await expect(mediaService.getById('999')).rejects.toThrow('Media not found');
  });
});
\`\`\`

### Integration Tests
\`\`\`typescript
describe('GET /api/media/:id', () => {
  it('should return media', async () => {
    const response = await request(app)
      .get('/api/media/123')
      .expect(200);
    
    expect(response.body.data).toMatchObject({ id: '123' });
  });
});
\`\`\`

### E2E Tests (Playwright)
\`\`\`typescript
test('should play media', async ({ page }) => {
  await page.goto('/');
  await page.click('[data-testid="media-card"]');
  await page.click('[data-testid="play-button"]');
  await expect(page.locator('[data-testid="player"]')).toHaveAttribute('data-playing', 'true');
});
\`\`\`

---

## ğŸ”’ Security Best Practices

- **Helmet.js:** Security headers (CSP, HSTS)
- **Rate Limiting:** 100 req/15min (API), 10 req/hour (downloads)
- **Input Validation:** Zod schemas for all inputs
- **CORS:** Restrict to frontend origin
- **SQL Injection:** Use Prisma ORM (safe by default)
- **Path Traversal:** Sanitize filenames
- **Secrets:** Use environment variables (never commit .env)

---

## ğŸš€ Performance Optimization

### Frontend
- **React.memo** for expensive components
- **useMemo/useCallback** for computed values
- **Code Splitting:** \`React.lazy()\` for routes
- **Virtual Scrolling:** For large media lists (react-window)

### Backend
- **Streaming:** Stream large files (audio/video)
- **Connection Pooling:** PostgreSQL connection limits
- **Caching:** Optional Redis for metadata

### Database
- **Indexes:** On playCount, liked, artist, createdAt
- **Query Optimization:** Use select/include, avoid N+1
- **Pagination:** Limit results to 50 per page

---

## ğŸ“‹ Common Tasks

### Adding a New API Endpoint
1. Define route in \`shared/constants/routes.ts\`
2. Add endpoint builder in \`shared/constants/endpoints.ts\`
3. Create service method in \`services/*.service.ts\`
4. Create controller in \`controllers/*.controller.ts\`
5. Register route in \`routes/*.routes.ts\`
6. Add validation schema (Zod)
7. Write tests (unit + integration)
8. Add to Bruno collection

### Adding a New React Component
1. Create component in \`components/<Name>/<Name>.tsx\`
2. Use Zustand for state (if needed)
3. Use centralized endpoints for API calls
4. Add accessibility attributes (ARIA, roles)
5. Write component tests (Vitest + Testing Library)
6. Add to Storybook (optional)

### Database Migration
1. Update \`prisma/schema.prisma\`
2. Run \`npx prisma migrate dev --name <description>\`
3. Run \`npx prisma generate\` (regenerate client)
4. Update services to use new schema

---

## ï¿½ï¿½ Detailed Documentation

For comprehensive patterns and guidelines, see:

- **Architecture:** \`.github/instructions/architecture.instructions.md\` (29KB)
- **Frontend:** \`.github/instructions/frontend.instructions.md\` (17KB)
- **Backend:** \`.github/instructions/backend.instructions.md\` (26KB)
- **API Routes:** \`.github/instructions/api-routes.instructions.md\` (22KB)
- **Testing:** \`.github/instructions/testing.instructions.md\` (6.4KB)
- **Security:** \`.github/instructions/security.instructions.md\` (7.5KB)
- **Performance:** \`.github/instructions/performance.instructions.md\` (11KB)
- **Error Handling:** \`.github/instructions/error-handling.instructions.md\` (9.5KB)
- **Docker:** \`.github/instructions/docker.instructions.md\` (13KB)
- **Database:** \`.github/instructions/database.instructions.md\` (13KB)
- **Player:** \`.github/instructions/player.instructions.md\` (8.3KB)
- **Download:** \`.github/instructions/download.instructions.md\` (10KB)
- **Code Quality:** \`.github/instructions/code-quality.instructions.md\` (16KB)
- **Git Workflow:** \`.github/instructions/git-workflow.instructions.md\` (14KB)
- **CI/CD:** \`.github/instructions/cicd.instructions.md\` (6.7KB)
- **API Testing:** \`.github/instructions/api-testing.instructions.md\` (17KB)

---

## ğŸ¤– Specialized Agents (Copilot Only)

Located in \`.github/copilot/agents/\` - invoke with \`@agent <name>\`:

- **expert-react-frontend-engineer** - React 19.2, hooks, performance
- **api-architect** - API design, versioning, error handling
- **typescript-mcp-expert** - TypeScript patterns, generics
- **devops-expert** - Docker, CI/CD, infrastructure
- **github-actions-expert** - GitHub Actions workflows
- **postgresql-dba** - Database optimization, queries
- **playwright-tester** - E2E testing, visual regression
- **debug** - Complex debugging, performance analysis
- **janitor** - Code cleanup, refactoring
- **accessibility** - WCAG compliance, ARIA

---

## ğŸ“ Development Philosophy

1. **Offline-First:** Player features work without internet
2. **Type-Safe:** TypeScript strict mode, no \`any\`
3. **Test-Driven:** Write tests alongside features
4. **Performance-Conscious:** Optimize from the start
5. **Accessible:** WCAG 2.1 AA compliance
6. **Secure by Default:** Validate inputs, sanitize outputs
7. **Clean Code:** ESLint + Prettier + Conventional Commits

---

**Last Updated:** 2026-02-13  
**Maintained By:** AI Development Team  
**Questions?** Reference detailed files in \`.github/instructions/\`
